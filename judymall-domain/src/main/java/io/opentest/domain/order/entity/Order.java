/*
 * Copyright 2019. OPENTEST. All rights reserved.
 */

package io.opentest.domain.order.entity;

import io.opentest.domain.customer.entity.Customer;
import lombok.AccessLevel;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;

import java.io.Serializable;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import javax.persistence.CascadeType;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import javax.persistence.ManyToOne;
import javax.persistence.OneToMany;
import javax.persistence.OneToOne;
import javax.persistence.PrePersist;
import javax.persistence.Table;

/**
 * 주문.
 */
@Entity
@Table(name = "T_ORDER")
@Builder
@NoArgsConstructor
@AllArgsConstructor(access = AccessLevel.PROTECTED)
public class Order implements Serializable {

    @Id
    @Getter
    @GeneratedValue
    private Long id;

    @ManyToOne
    @JoinColumn(name = "customer_id", referencedColumnName = "id")
    private Customer customer;

    private LocalDateTime createdAt;

    @Getter
    @Builder.Default
    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
    private List<OrderDetail> orderDetails = new ArrayList<>();

    @Getter
    @Builder.Default
    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
    private List<OrderPayment> payments = new ArrayList<>();

    @OneToOne(mappedBy = "order", cascade = CascadeType.ALL)
    private ShippingAddress shippingAddress;

    @PrePersist
    void createdAt() {
        this.createdAt = LocalDateTime.now();
    }

    public void setCustomer(Customer customer) {
        this.customer = customer;
    }

    public void addOrderDetail(final OrderDetail orderDetail) {
        this.orderDetails.add(orderDetail);
        orderDetail.order = this;
    }

    public void addOrderPayment(final OrderPayment payment) {
        this.payments.add(payment);
        payment.order = this;
    }

    /*
    public void setShippingAddress(ShippingAddress shippingAddress) {
        // Validation logic here
        this.shippingAddress = shippingAddress;
    }
    */

    public void changeShippingAddress(ShippingAddress shippingAddress) {
        // Validation logic here
        //setShippingAddress(shippingAddress);
        this.shippingAddress = shippingAddress;
        shippingAddress.order = this;
    }

    public void placeOrder() {
        this.validate();
        // Other validation policy
    }

    private void validate() {
        this.validatePaymentMethodPolicyOfOrderDetails();
    }

    private void validatePaymentMethodPolicyOfOrderDetails() {
        boolean contains = this.getOrderDetails()
                .stream()
                .anyMatch(
                        lineItem -> lineItem
                                .getProductId()
                                .equalsIgnoreCase("P-0004")
                );

        if (contains) {
            if (this.getPayments().size() != 1
                    || this.getPayments()
                            .stream()
                            .anyMatch(
                                    orderPayment -> !orderPayment.isCreditCard()
                            )
            ) {
                throw new IllegalArgumentException("P-0004 상품은 신용카드로만 결제가 가능합니다");
            }
        }
    }

    /*
    public static class OrderBuilder {
        public OrderBuilder shippingAddress(ShippingAddress shippingAddress) {
            this.shippingAddress = shippingAddress;
            //shippingAddress.order =
            return this;
        }
    }
    */
}
